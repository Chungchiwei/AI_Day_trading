"""
æ•¸æ“šç²å–æ¨¡çµ„ - å¾ FinMind API ç²å–è‚¡ç¥¨æ•¸æ“šï¼ˆæ•´åˆè³‡æ–™åº«å¿«å–ï¼‰
"""

import requests
import pandas as pd
from datetime import datetime, timedelta
from modules.database import get_database

# âœ… æ–°å¢ï¼šå°è‚¡ä»£ç¢¼èˆ‡åç¨±å°æ‡‰è¡¨ï¼ˆå¸¸è¦‹è‚¡ç¥¨ï¼‰
STOCK_NAMES = {
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2882": "åœ‹æ³°é‡‘",
    "2881": "å¯Œé‚¦é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "6505": "å°å¡‘åŒ–",
    "2382": "å»£é”",
    "2357": "è¯ç¢©",
    "3008": "å¤§ç«‹å…‰",
    "2327": "åœ‹å·¨",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2379": "ç‘æ˜±",
    "2395": "ç ”è¯",
    "3034": "è¯è© ",
    "2408": "å—äºç§‘",
    "2409": "å‹é”",
    "2474": "å¯æˆ",
    "0050": "å…ƒå¤§å°ç£50",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "006208": "å¯Œé‚¦å°50",
}

def get_stock_name(symbol):
    """
    âœ… å–å¾—è‚¡ç¥¨ä¸­æ–‡åç¨±
    
    åƒæ•¸:
        symbol: è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¯å« .TWï¼‰
    
    è¿”å›:
        tuple: (è‚¡ç¥¨ä»£ç¢¼, è‚¡ç¥¨ä¸­æ–‡åç¨±)
    """
    # ç§»é™¤ .TW å¾Œç¶´
    clean_symbol = symbol.replace(".TW", "").strip()
    
    # å¾å°æ‡‰è¡¨æŸ¥è©¢
    stock_name = STOCK_NAMES.get(clean_symbol, "")
    
    # è¿”å›ä»£ç¢¼å’Œåç¨±çš„å…ƒçµ„
    if stock_name:
        return clean_symbol, stock_name
    else:
        return clean_symbol, clean_symbol  # æ‰¾ä¸åˆ°åç¨±å°±è¿”å›ä»£ç¢¼


def test_finmind_api(token, symbol="2330"):
    """
    æ¸¬è©¦ FinMind API é€£ç·šèˆ‡æ•¸æ“šæ ¼å¼
    
    åƒæ•¸:
        token: FinMind API Token
        symbol: æ¸¬è©¦ç”¨è‚¡ç¥¨ä»£ç¢¼
    
    è¿”å›:
        dict: æ¸¬è©¦çµæœ
    """
    try:
        url = "https://api.finmindtrade.com/api/v4/data"
        
        params = {
            "dataset": "TaiwanStockPrice",
            "data_id": symbol,
            "start_date": (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d"),
            "end_date": datetime.now().strftime("%Y-%m-%d"),
            "token": token
        }
        
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        
        if data.get("status") == 200 and data.get("data"):
            df = pd.DataFrame(data["data"])
            
            return {
                "success": True,
                "message": "API æ¸¬è©¦æˆåŠŸ",
                "columns": list(df.columns),
                "data_count": len(df)
            }
        else:
            return {
                "success": False,
                "message": data.get("msg", "æœªçŸ¥éŒ¯èª¤"),
                "columns": [],
                "data_count": 0
            }
            
    except Exception as e:
        return {
            "success": False,
            "message": str(e),
            "columns": [],
            "data_count": 0
        }


def get_stock_data(symbol, start_date, end_date, token, force_update=False):
    """
    ç²å–è‚¡ç¥¨æ­·å²åƒ¹æ ¼æ•¸æ“šï¼ˆæ”¯æ´å¿«å–ï¼‰
    
    åƒæ•¸:
        symbol: è‚¡ç¥¨ä»£ç¢¼
        start_date: é–‹å§‹æ—¥æœŸ (YYYY-MM-DD)
        end_date: çµæŸæ—¥æœŸ (YYYY-MM-DD)
        token: FinMind API Token
        force_update: æ˜¯å¦å¼·åˆ¶å¾ API æ›´æ–°
    
    è¿”å›:
        DataFrame: è‚¡ç¥¨åƒ¹æ ¼æ•¸æ“š
    """
    try:
        db = get_database()
        clean_symbol = symbol.replace(".TW", "")
        
        # å˜—è©¦å¾å¿«å–è®€å–
        if not force_update:
            cached_data = db.get_stock_prices(clean_symbol, start_date, end_date)
            if cached_data is not None and not cached_data.empty:
                print(f"âœ… å¾å¿«å–è®€å– {clean_symbol} çš„åƒ¹æ ¼æ•¸æ“š")
                return cached_data
        
        # å¾ API ç²å–
        print(f"ğŸŒ å¾ FinMind API ç²å– {clean_symbol} çš„æ•¸æ“š...")
        
        url = "https://api.finmindtrade.com/api/v4/data"
        
        params = {
            "dataset": "TaiwanStockPrice",
            "data_id": clean_symbol,
            "start_date": start_date,
            "end_date": end_date,
            "token": token
        }
        
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        
        if data.get("status") != 200:
            print(f"âŒ API è¿”å›éŒ¯èª¤: {data.get('msg', 'æœªçŸ¥éŒ¯èª¤')}")
            return None
        
        if not data.get("data"):
            print(f"âŒ ç„¡æ•¸æ“šè¿”å›")
            return None
        
        df = pd.DataFrame(data["data"])
        
        # âœ… ç¢ºä¿æ¬„ä½åç¨±æ­£ç¢º
        df = df.rename(columns={
            'Trading_Volume': 'volume',
            'Open': 'open',
            'High': 'high',
            'Low': 'low',
            'Close': 'close',
            'date': 'date'  # ç¢ºä¿æœ‰ date æ¬„ä½
        })
        
        # âœ… ç¢ºä¿ date æ¬„ä½å­˜åœ¨ä¸”æ ¼å¼æ­£ç¢º
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
        else:
            print(f"âŒ æ•¸æ“šä¸­ç¼ºå°‘ date æ¬„ä½")
            return None
        
        # æ’åºä¸¦é‡ç½®ç´¢å¼•
        df = df.sort_values('date').reset_index(drop=True)
        
        # å„²å­˜åˆ°å¿«å–
        db.save_stock_prices(clean_symbol, df)
        
        print(f"âœ… æˆåŠŸç²å– {len(df)} ç­†æ•¸æ“š")
        return df
        
    except Exception as e:
        print(f"âŒ ç²å–è‚¡ç¥¨æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")
        return None


def get_institutional_data(symbol, start_date, end_date, token, force_update=False):
    """
    ç²å–ä¸‰å¤§æ³•äººè²·è³£è¶…æ•¸æ“šï¼ˆæ”¯æ´å¿«å–ï¼‰
    
    åƒæ•¸:
        symbol: è‚¡ç¥¨ä»£ç¢¼
        start_date: é–‹å§‹æ—¥æœŸ
        end_date: çµæŸæ—¥æœŸ
        token: FinMind API Token
        force_update: æ˜¯å¦å¼·åˆ¶å¾ API æ›´æ–°
    
    è¿”å›:
        DataFrame: æ³•äººè²·è³£è¶…æ•¸æ“š
    """
    try:
        db = get_database()
        clean_symbol = symbol.replace(".TW", "")
        
        # å˜—è©¦å¾å¿«å–è®€å–
        if not force_update:
            cached_data = db.get_institutional_data(clean_symbol, start_date, end_date)
            if cached_data is not None and not cached_data.empty:
                print(f"âœ… å¾å¿«å–è®€å– {clean_symbol} çš„ç±Œç¢¼æ•¸æ“š")
                return cached_data
        
        # å¾ API ç²å–
        print(f"ğŸŒ å¾ FinMind API ç²å– {clean_symbol} çš„ç±Œç¢¼æ•¸æ“š...")
        
        url = "https://api.finmindtrade.com/api/v4/data"
        
        params = {
            "dataset": "TaiwanStockInstitutionalInvestors",
            "data_id": clean_symbol,
            "start_date": start_date,
            "end_date": end_date,
            "token": token
        }
        
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        
        if data.get("status") != 200 or not data.get("data"):
            print(f"âš ï¸ ç„¡æ³•ç²å–ç±Œç¢¼æ•¸æ“š")
            return None
        
        df = pd.DataFrame(data["data"])
        
        # âœ… ç¢ºä¿ date æ¬„ä½å­˜åœ¨
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
        
        # å„²å­˜åˆ°å¿«å–
        db.save_institutional_data(clean_symbol, df)
        
        print(f"âœ… æˆåŠŸç²å– {len(df)} ç­†ç±Œç¢¼æ•¸æ“š")
        return df
        
    except Exception as e:
        print(f"âŒ ç²å–ç±Œç¢¼æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")
        return None
