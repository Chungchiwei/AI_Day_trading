"""
è³‡æ–™åº«æ¨¡çµ„ - ç®¡ç†è‚¡ç¥¨æ•¸æ“šçš„æœ¬åœ°å¿«å–
"""

import sqlite3
import pandas as pd
from datetime import datetime, timedelta
import os

class StockDatabase:
    """è‚¡ç¥¨æ•¸æ“šè³‡æ–™åº«ç®¡ç†é¡"""
    
    def __init__(self, db_path='data/stock_data.db'):
        """
        åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
        
        åƒæ•¸:
            db_path: è³‡æ–™åº«æ–‡ä»¶è·¯å¾‘
        """
        # ç¢ºä¿ç›®éŒ„å­˜åœ¨
        os.makedirs(os.path.dirname(db_path), exist_ok=True)
        
        self.db_path = db_path
        self.conn = None
        self._connect()
        self._create_tables()
    
    def _connect(self):
        """å»ºç«‹è³‡æ–™åº«é€£æ¥"""
        try:
            self.conn = sqlite3.connect(self.db_path, check_same_thread=False)
            self.conn.execute("PRAGMA journal_mode=WAL")  # æå‡ä¸¦ç™¼æ€§èƒ½
            print(f"âœ… è³‡æ–™åº«é€£æ¥æˆåŠŸ: {self.db_path}")
        except Exception as e:
            print(f"âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—: {e}")
            raise
    
    def _create_tables(self):
        """å‰µå»ºå¿…è¦çš„æ•¸æ“šè¡¨"""
        try:
            cursor = self.conn.cursor()
            
            # è‚¡ç¥¨åƒ¹æ ¼è¡¨
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS stock_prices (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    symbol TEXT NOT NULL,
                    date DATE NOT NULL,
                    open REAL,
                    high REAL,
                    low REAL,
                    close REAL,
                    volume INTEGER,
                    amount REAL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(symbol, date)
                )
            """)
            
            # ä¸‰å¤§æ³•äººæ•¸æ“šè¡¨
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS institutional_investors (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    symbol TEXT NOT NULL,
                    date DATE NOT NULL,
                    foreign_investor REAL,
                    investment_trust REAL,
                    dealer REAL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(symbol, date)
                )
            """)
            
            # æŠ€è¡“æŒ‡æ¨™è¡¨
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS technical_indicators (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    symbol TEXT NOT NULL,
                    date DATE NOT NULL,
                    indicator_name TEXT NOT NULL,
                    indicator_value REAL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(symbol, date, indicator_name)
                )
            """)
            
            # å‰µå»ºç´¢å¼•ä»¥æå‡æŸ¥è©¢æ•ˆç‡
            cursor.execute("""
                CREATE INDEX IF NOT EXISTS idx_stock_prices_symbol_date 
                ON stock_prices(symbol, date)
            """)
            
            cursor.execute("""
                CREATE INDEX IF NOT EXISTS idx_institutional_symbol_date 
                ON institutional_investors(symbol, date)
            """)
            
            self.conn.commit()
            print("âœ… è³‡æ–™è¡¨å‰µå»º/æª¢æŸ¥å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ å‰µå»ºè³‡æ–™è¡¨å¤±æ•—: {e}")
            raise
    
    def save_stock_data(self, symbol, df):
        """
        å„²å­˜è‚¡ç¥¨åƒ¹æ ¼æ•¸æ“š
        
        åƒæ•¸:
            symbol: è‚¡ç¥¨ä»£ç¢¼
            df: åŒ…å«è‚¡ç¥¨æ•¸æ“šçš„ DataFrame
        """
        try:
            if df is None or df.empty:
                return
            
            # æº–å‚™æ•¸æ“š
            df_copy = df.copy()
            df_copy['symbol'] = symbol
            df_copy['date'] = pd.to_datetime(df_copy['date']).dt.strftime('%Y-%m-%d')
            
            # é¸æ“‡éœ€è¦çš„æ¬„ä½
            columns = ['symbol', 'date', 'open', 'high', 'low', 'close', 'volume', 'amount']
            df_save = df_copy[columns]
            
            # ä½¿ç”¨ REPLACE INTO ä¾†è™•ç†é‡è¤‡æ•¸æ“š
            df_save.to_sql('stock_prices', self.conn, if_exists='append', index=False, method='multi')
            
            # æ¸…ç†é‡è¤‡æ•¸æ“š
            cursor = self.conn.cursor()
            cursor.execute("""
                DELETE FROM stock_prices 
                WHERE id NOT IN (
                    SELECT MIN(id) 
                    FROM stock_prices 
                    GROUP BY symbol, date
                )
            """)
            
            self.conn.commit()
            print(f"âœ… å·²å„²å­˜ {symbol} çš„ {len(df_save)} ç­†æ•¸æ“šåˆ°è³‡æ–™åº«")
            
        except Exception as e:
            print(f"âŒ å„²å­˜è‚¡ç¥¨æ•¸æ“šå¤±æ•—: {e}")
            self.conn.rollback()
    
    def get_stock_data(self, symbol, start_date=None, end_date=None):
        """
        è®€å–è‚¡ç¥¨åƒ¹æ ¼æ•¸æ“š
        
        åƒæ•¸:
            symbol: è‚¡ç¥¨ä»£ç¢¼
            start_date: é–‹å§‹æ—¥æœŸ (YYYY-MM-DD)
            end_date: çµæŸæ—¥æœŸ (YYYY-MM-DD)
        
        è¿”å›:
            DataFrame: è‚¡ç¥¨æ•¸æ“š
        """
        try:
            query = "SELECT * FROM stock_prices WHERE symbol = ?"
            params = [symbol]
            
            if start_date:
                query += " AND date >= ?"
                params.append(start_date)
            
            if end_date:
                query += " AND date <= ?"
                params.append(end_date)
            
            query += " ORDER BY date"
            
            df = pd.read_sql_query(query, self.conn, params=params)
            
            if not df.empty:
                df['date'] = pd.to_datetime(df['date'])
            
            return df
            
        except Exception as e:
            print(f"âŒ è®€å–è‚¡ç¥¨æ•¸æ“šå¤±æ•—: {e}")
            return None
    
    def save_institutional_data(self, symbol, df):
        """
        å„²å­˜ä¸‰å¤§æ³•äººæ•¸æ“š
        
        åƒæ•¸:
            symbol: è‚¡ç¥¨ä»£ç¢¼
            df: åŒ…å«æ³•äººæ•¸æ“šçš„ DataFrame
        """
        try:
            if df is None or df.empty:
                return
            
            # æº–å‚™æ•¸æ“š
            df_copy = df.copy()
            df_copy['symbol'] = symbol
            df_copy['date'] = pd.to_datetime(df_copy['date']).dt.strftime('%Y-%m-%d')
            
            # é‡å‘½åæ¬„ä½ä»¥åŒ¹é…è³‡æ–™åº«
            column_mapping = {
                'Foreign_Investor': 'foreign_investor',
                'Investment_Trust': 'investment_trust',
                'Dealer': 'dealer'
            }
            
            # åªé‡å‘½åå­˜åœ¨çš„æ¬„ä½
            existing_mappings = {k: v for k, v in column_mapping.items() if k in df_copy.columns}
            if existing_mappings:
                df_copy = df_copy.rename(columns=existing_mappings)
            
            # é¸æ“‡éœ€è¦çš„æ¬„ä½ï¼ˆè™•ç†å¯èƒ½ç¼ºå°‘çš„æ¬„ä½ï¼‰
            base_columns = ['symbol', 'date']
            optional_columns = ['foreign_investor', 'investment_trust', 'dealer']
            
            # ç‚ºç¼ºå°‘çš„æ¬„ä½å¡«å…… 0
            for col in optional_columns:
                if col not in df_copy.columns:
                    df_copy[col] = 0
            
            columns = base_columns + optional_columns
            df_save = df_copy[columns]
            
            # å„²å­˜åˆ°è³‡æ–™åº«
            df_save.to_sql('institutional_investors', self.conn, if_exists='append', index=False, method='multi')
            
            # æ¸…ç†é‡è¤‡æ•¸æ“š
            cursor = self.conn.cursor()
            cursor.execute("""
                DELETE FROM institutional_investors 
                WHERE id NOT IN (
                    SELECT MIN(id) 
                    FROM institutional_investors 
                    GROUP BY symbol, date
                )
            """)
            
            self.conn.commit()
            print(f"âœ… å·²å„²å­˜ {symbol} çš„ {len(df_save)} ç­†æ³•äººæ•¸æ“šåˆ°è³‡æ–™åº«")
            
        except Exception as e:
            print(f"âŒ å„²å­˜æ³•äººæ•¸æ“šå¤±æ•—: {e}")
            import traceback
            print(traceback.format_exc())
            self.conn.rollback()
    
    def get_institutional_data(self, symbol, start_date=None, end_date=None):
        """
        è®€å–ä¸‰å¤§æ³•äººæ•¸æ“š
        
        åƒæ•¸:
            symbol: è‚¡ç¥¨ä»£ç¢¼
            start_date: é–‹å§‹æ—¥æœŸ (YYYY-MM-DDï¼Œå¯é¸)
            end_date: çµæŸæ—¥æœŸ (YYYY-MM-DDï¼Œå¯é¸)
        
        è¿”å›:
            DataFrame: æ³•äººæ•¸æ“š
        """
        try:
            query = "SELECT * FROM institutional_investors WHERE symbol = ?"
            params = [symbol]
            
            if start_date:
                query += " AND date >= ?"
                params.append(start_date)
            
            if end_date:
                query += " AND date <= ?"
                params.append(end_date)
            
            query += " ORDER BY date"
            
            df = pd.read_sql_query(query, self.conn, params=params)
            
            if not df.empty:
                df['date'] = pd.to_datetime(df['date'])
                
                # é‡å‘½åæ¬„ä½ä»¥åŒ¹é…åŸå§‹æ ¼å¼
                df = df.rename(columns={
                    'foreign_investor': 'Foreign_Investor',
                    'investment_trust': 'Investment_Trust',
                    'dealer': 'Dealer'
                })
            
            return df
            
        except Exception as e:
            print(f"âŒ è®€å–æ³•äººæ•¸æ“šå¤±æ•—: {e}")
            return None
    
    def save_technical_indicator(self, symbol, date, indicator_name, indicator_value):
        """
        å„²å­˜æŠ€è¡“æŒ‡æ¨™
        
        åƒæ•¸:
            symbol: è‚¡ç¥¨ä»£ç¢¼
            date: æ—¥æœŸ
            indicator_name: æŒ‡æ¨™åç¨±
            indicator_value: æŒ‡æ¨™å€¼
        """
        try:
            cursor = self.conn.cursor()
            
            cursor.execute("""
                INSERT OR REPLACE INTO technical_indicators 
                (symbol, date, indicator_name, indicator_value)
                VALUES (?, ?, ?, ?)
            """, (symbol, date, indicator_name, indicator_value))
            
            self.conn.commit()
            
        except Exception as e:
            print(f"âŒ å„²å­˜æŠ€è¡“æŒ‡æ¨™å¤±æ•—: {e}")
            self.conn.rollback()
    
    def get_technical_indicators(self, symbol, start_date=None, end_date=None):
        """
        è®€å–æŠ€è¡“æŒ‡æ¨™
        
        åƒæ•¸:
            symbol: è‚¡ç¥¨ä»£ç¢¼
            start_date: é–‹å§‹æ—¥æœŸ
            end_date: çµæŸæ—¥æœŸ
        
        è¿”å›:
            DataFrame: æŠ€è¡“æŒ‡æ¨™æ•¸æ“š
        """
        try:
            query = "SELECT * FROM technical_indicators WHERE symbol = ?"
            params = [symbol]
            
            if start_date:
                query += " AND date >= ?"
                params.append(start_date)
            
            if end_date:
                query += " AND date <= ?"
                params.append(end_date)
            
            query += " ORDER BY date, indicator_name"
            
            df = pd.read_sql_query(query, self.conn, params=params)
            
            if not df.empty:
                df['date'] = pd.to_datetime(df['date'])
            
            return df
            
        except Exception as e:
            print(f"âŒ è®€å–æŠ€è¡“æŒ‡æ¨™å¤±æ•—: {e}")
            return None
    
    def clear_old_data(self, days=90):
        """
        æ¸…ç†èˆŠæ•¸æ“š
        
        åƒæ•¸:
            days: ä¿ç•™æœ€è¿‘å¹¾å¤©çš„æ•¸æ“š
        """
        try:
            cutoff_date = (datetime.now() - timedelta(days=days)).strftime('%Y-%m-%d')
            
            cursor = self.conn.cursor()
            
            # æ¸…ç†èˆŠçš„è‚¡ç¥¨æ•¸æ“š
            cursor.execute("DELETE FROM stock_prices WHERE date < ?", (cutoff_date,))
            deleted_prices = cursor.rowcount
            
            # æ¸…ç†èˆŠçš„æ³•äººæ•¸æ“š
            cursor.execute("DELETE FROM institutional_investors WHERE date < ?", (cutoff_date,))
            deleted_institutional = cursor.rowcount
            
            # æ¸…ç†èˆŠçš„æŠ€è¡“æŒ‡æ¨™
            cursor.execute("DELETE FROM technical_indicators WHERE date < ?", (cutoff_date,))
            deleted_indicators = cursor.rowcount
            
            self.conn.commit()
            
            print(f"âœ… å·²æ¸…ç† {cutoff_date} ä¹‹å‰çš„æ•¸æ“š:")
            print(f"   - è‚¡ç¥¨åƒ¹æ ¼: {deleted_prices} ç­†")
            print(f"   - æ³•äººæ•¸æ“š: {deleted_institutional} ç­†")
            print(f"   - æŠ€è¡“æŒ‡æ¨™: {deleted_indicators} ç­†")
            
        except Exception as e:
            print(f"âŒ æ¸…ç†èˆŠæ•¸æ“šå¤±æ•—: {e}")
            self.conn.rollback()
    
    def get_database_stats(self):
        """
        ç²å–è³‡æ–™åº«çµ±è¨ˆä¿¡æ¯
        
        è¿”å›:
            dict: çµ±è¨ˆä¿¡æ¯
        """
        try:
            cursor = self.conn.cursor()
            
            stats = {}
            
            # è‚¡ç¥¨æ•¸æ“šçµ±è¨ˆ
            cursor.execute("SELECT COUNT(*) FROM stock_prices")
            stats['stock_prices_count'] = cursor.fetchone()[0]
            
            cursor.execute("SELECT COUNT(DISTINCT symbol) FROM stock_prices")
            stats['unique_symbols'] = cursor.fetchone()[0]
            
            # æ³•äººæ•¸æ“šçµ±è¨ˆ
            cursor.execute("SELECT COUNT(*) FROM institutional_investors")
            stats['institutional_count'] = cursor.fetchone()[0]
            
            # æŠ€è¡“æŒ‡æ¨™çµ±è¨ˆ
            cursor.execute("SELECT COUNT(*) FROM technical_indicators")
            stats['indicators_count'] = cursor.fetchone()[0]
            
            # è³‡æ–™åº«å¤§å°
            cursor.execute("SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size()")
            stats['database_size_mb'] = cursor.fetchone()[0] / (1024 * 1024)
            
            return stats
            
        except Exception as e:
            print(f"âŒ ç²å–çµ±è¨ˆä¿¡æ¯å¤±æ•—: {e}")
            return {}
    
    def close(self):
        """é—œé–‰è³‡æ–™åº«é€£æ¥"""
        if self.conn:
            self.conn.close()
            print("âœ… è³‡æ–™åº«é€£æ¥å·²é—œé–‰")
    
    def __del__(self):
        """ææ§‹å‡½æ•¸ï¼Œç¢ºä¿é€£æ¥é—œé–‰"""
        self.close()


# å…¨å±€è³‡æ–™åº«å¯¦ä¾‹
_db_instance = None

def get_database():
    """
    ç²å–è³‡æ–™åº«å–®ä¾‹
    
    è¿”å›:
        StockDatabase: è³‡æ–™åº«å¯¦ä¾‹
    """
    global _db_instance
    if _db_instance is None:
        _db_instance = StockDatabase()
    return _db_instance


if __name__ == "__main__":
    # æ¸¬è©¦è³‡æ–™åº«åŠŸèƒ½
    db = get_database()
    
    # é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
    stats = db.get_database_stats()
    print("\nğŸ“Š è³‡æ–™åº«çµ±è¨ˆ:")
    for key, value in stats.items():
        print(f"   {key}: {value}")
    
    # æ¸¬è©¦æ¸…ç†èˆŠæ•¸æ“š
    # db.clear_old_data(days=90)
